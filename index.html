<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>数字统计工具</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 15px;
            max-width: 800px;
            margin: 0 auto;
        }

        .container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        textarea {
            width: 100%;
            min-height: 100px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 16px; /* 移动端更友好的字体大小 */
            box-sizing: border-box;
        }

        #highlightedText {
            width: 100%;
            min-height: 100px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            white-space: pre-wrap;
            user-select: none;
            pointer-events: none;
            background: #f9f9f9;
            font-size: 16px;
            box-sizing: border-box;
        }

        .highlight-number {
            background-color: #ffeb3b;
            padding: 2px 4px;
            border-radius: 3px;
        }

        .highlight-count {
            background-color: #4caf50;
            color: white;
            padding: 2px 4px;
            border-radius: 3px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 16px;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }

        /* 添加说明列的样式 */
        td.note-cell {
            text-align: left;
            padding: 4px;
        }

        .note-input {
            width: 100%;
            padding: 4px;
            border: none;
            background: transparent;
            font-size: inherit;
        }

        .note-input:focus {
            outline: 2px solid #4CAF50;
            background: white;
        }

        th {
            background-color: #f5f5f5;
        }

        /* 移动端优化 */
        @media (max-width: 600px) {
            body {
                padding: 10px;
            }

            .container {
                gap: 10px;
            }

            textarea, #highlightedText {
                font-size: 16px;
                min-height: 80px;
            }

            table {
                font-size: 14px;
            }

            th, td {
                padding: 6px;
            }
        }

        /* 添加清除按钮 */
        .button-container {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        button {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            flex: 1;
        }

        button:active {
            background-color: #45a049;
        }

        /* 添加说明文字 */
        .instructions {
            margin-bottom: 15px;
            color: #666;
            font-size: 14px;
            line-height: 1.4;
        }

        /* 添加变化值设置区域的样式 */
        .adjustment-container {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .adjustment-field {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .adjustment-input {
            width: 60px;
            padding: 4px;
            border: 1px solid #ccc;
            border-radius: 4px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="instructions">
            <p>使用说明：</p>
            <ul>
                <li>在输入框中输入需要统计的数字和计数（如：489，357九单一组28）</li>
                <li>支持1-100的中文数字和阿拉伯数字</li>
                <li>支持逗号、空格、点、加号分隔数字</li>
                <li>可设置单数和组数的变化值（正数为增加，负数为减少）</li>
                <li>可为每个数字添加说明，说明内容会自动保存</li>
            </ul>
        </div>
        
        <!-- 添加变化值设置区域 -->
        <div class="adjustment-container">
            <div class="adjustment-field">
                <label>单数变化值:</label>
                <input type="number" id="singleAdjustment" class="adjustment-input" value="0">
            </div>
            <div class="adjustment-field">
                <label>组数变化值:</label>
                <input type="number" id="groupAdjustment" class="adjustment-input" value="0">
            </div>
        </div>
        
        <textarea id="inputText" placeholder="请在此输入文本..."></textarea>
        <div id="highlightedText"></div>
        
        <div class="button-container">
            <button onclick="clearInput()">清空输入</button>
            <button onclick="copyResults()">复制结果</button>
        </div>

        <table>
            <thead>
                <tr>
                    <th>数字</th>
                    <th>单数</th>
                    <th>组数</th>
                    <th>说明</th>
                </tr>
            </thead>
            <tbody id="resultTable">
            </tbody>
        </table>
    </div>

    <script>
        const inputText = document.getElementById('inputText');
        const highlightedText = document.getElementById('highlightedText');
        const resultTable = document.getElementById('resultTable');

        // 中文数字映射
        const chineseNumbers = {
            '一': 1, '二': 2, '三': 3, '四': 4, '五': 5,
            '六': 6, '七': 7, '八': 8, '九': 9, '十': 10,
            '十一': 11, '十二': 12, '十三': 13, '十四': 14, '十五': 15,
            '十六': 16, '十七': 17, '十八': 18, '十九': 19, '二十': 20,
            '二十一': 21, '二十二': 22, '二十三': 23, '二十四': 24, '二十五': 25,
            '二十六': 26, '二十七': 27, '二十八': 28, '二十九': 29, '三十': 30,
            '三十一': 31, '三十二': 32, '三十三': 33, '三十四': 34, '三十五': 35,
            '三十六': 36, '三十七': 37, '三十八': 38, '三十九': 39, '四十': 40,
            '四十一': 41, '四十二': 42, '四十三': 43, '四十四': 44, '四十五': 45,
            '四十六': 46, '四十七': 47, '四十八': 48, '四十九': 49, '五十': 50,
            '五十一': 51, '五十二': 52, '五十三': 53, '五十四': 54, '五十五': 55,
            '五十六': 56, '五十七': 57, '五十八': 58, '五十九': 59, '六十': 60,
            '六十一': 61, '六十二': 62, '六十三': 63, '六十四': 64, '六十五': 65,
            '六十六': 66, '六十七': 67, '六十八': 68, '六十九': 69, '七十': 70,
            '七十一': 71, '七十二': 72, '七十三': 73, '七十四': 74, '七十五': 75,
            '七十六': 76, '七十七': 77, '七十八': 78, '七十九': 79, '八十': 80,
            '八十一': 81, '八十二': 82, '八十三': 83, '八十四': 84, '八十五': 85,
            '八十六': 86, '八十七': 87, '八十八': 88, '八十九': 89, '九十': 90,
            '九十一': 91, '九十二': 92, '九十三': 93, '九十四': 94, '九十五': 95,
            '九十六': 96, '九十七': 97, '九十八': 98, '九十九': 99, '一百': 100,
            '两': 2
        };

        const numberPattern = Object.keys(chineseNumbers).join('|');

        function processText(text) {
            const arabicPattern = '(?:[1-9]|[1-9]\\d|100)';
            const fullNumberPattern = `(?:${numberPattern}|${arabicPattern})`;
            
            const lines = text.split('\n');
            let processed = lines.map(line => {
                const countDescPattern = new RegExp(`(${fullNumberPattern})[单倍直](?:(?:${fullNumberPattern})组)?|(${fullNumberPattern})组`, 'g');
                return processLine(line, countDescPattern);
            }).join('\n');
            
            return processed;
        }

        function processLine(line, countDescPattern) {
            // 查找所有计数描述
            const countMatches = [...line.matchAll(countDescPattern)];
            const highlights = [];
            
            countMatches.forEach(match => {
                const countDesc = match[0];
                const countIndex = match.index;
                
                highlights.push({
                    start: countIndex,
                    end: countIndex + countDesc.length,
                    text: countDesc,
                    type: 'count'
                });

                // 获取这个计数描述之前的文本
                const textBefore = line.substring(0, countIndex);
                
                // 添加。作为分隔符
                const numbers = [...textBefore.matchAll(/\d{3}(?=[，,\s.。、+\-]|$)|(?<=[，,\s.。、+\-]|^)\d{3}/g)];
                numbers.forEach(numMatch => {
                    const numStart = numMatch.index;
                    const beforeChar = numStart > 0 ? textBefore[numStart - 1] : '';
                    const afterChar = textBefore[numStart + 3] || '';
                    
                    // 在分隔符列表中添加。
                    if ((!beforeChar || /[，,\s.。、+\-]/.test(beforeChar)) && 
                        (!afterChar || /[，,\s.。、+\-]/.test(afterChar))) {
                        highlights.push({
                            start: numStart,
                            end: numStart + 3,
                            text: numMatch[0],
                            type: 'number'
                        });
                    }
                });
            });

            highlights.sort((a, b) => a.start - b.start);
            
            let result = line;
            for (let i = highlights.length - 1; i >= 0; i--) {
                const h = highlights[i];
                const before = result.substring(0, h.start);
                const after = result.substring(h.end);
                const highlightClass = h.type === 'number' ? 'highlight-number' : 'highlight-count';
                result = before + `<span class="${highlightClass}">${h.text}</span>` + after;
            }
            
            return result;
        }

        function updateStatistics() {
            const numbers = new Map();
            const lines = highlightedText.innerHTML
                .split(/<br\s*\/?>/i)
                .filter(line => line.trim());
            
            // 获取变化值
            const singleAdjustment = parseInt(document.getElementById('singleAdjustment').value) || 0;
            const groupAdjustment = parseInt(document.getElementById('groupAdjustment').value) || 0;
            
            // 收集数据
            lines.forEach((line, index) => {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = line.trim();
                
                const numberSpans = tempDiv.querySelectorAll('.highlight-number');
                const countSpan = tempDiv.querySelector('.highlight-count');
                
                if (!countSpan || !numberSpans.length) return;
                
                const countText = countSpan.textContent;
                const arabicPattern = '(?:[1-9]|[1-9]\\d|100)';
                const fullNumberPattern = `(?:${numberPattern}|${arabicPattern})`;
                
                let singleCount = 0;
                let groupCount = 0;
                
                const singleMatch = countText.match(new RegExp(`(${fullNumberPattern})[单倍直]`));
                if (singleMatch) {
                    const count = singleMatch[1];
                    singleCount = chineseNumbers[count] || parseInt(count);
                }
                
                const groupMatch = countText.match(new RegExp(`(${fullNumberPattern})组`));
                if (groupMatch) {
                    const count = groupMatch[1];
                    groupCount = chineseNumbers[count] || parseInt(count);
                }
                
                Array.from(numberSpans).forEach(span => {
                    const num = span.textContent;
                    if (!numbers.has(num)) {
                        numbers.set(num, {
                            single: singleCount,
                            group: groupCount
                        });
                    } else {
                        const current = numbers.get(num);
                        numbers.set(num, {
                            single: current.single + singleCount,
                            group: current.group + groupCount
                        });
                    }
                });
            });

            // 转换为数组并排序
            const sortedResults = Array.from(numbers.entries())
                .map(([number, counts]) => ({
                    number,
                    single: parseInt(counts.single) || 0,  // 确保是数字
                    group: parseInt(counts.group) || 0     // 确保是数字
                }));

            // console.log('Before sorting:', sortedResults);

            // 排序
            sortedResults.sort((a, b) => {
                // console.log(`Comparing:`, 
                    // `\n${a.number}(${a.single}单${a.group}组) vs ${b.number}(${b.single}单${b.group}组)`);
                
                // 首先按单数从高到低排序
                if (a.single !== b.single) {
                    // console.log(`Different singles: ${b.single} - ${a.single} = ${b.single - a.single}`);
                    return b.single - a.single;
                }
                
                // 单数相同时，按组数从高到低排序
                // console.log(`Same singles, comparing groups: ${b.group} - ${a.group} = ${b.group - a.group}`);
                return b.group - a.group;
            });

            // console.log('After sorting:', sortedResults);

            // 更新表格
            resultTable.innerHTML = '';
            sortedResults.forEach(result => {
                const row = resultTable.insertRow();
                row.insertCell(0).textContent = result.number;
                row.insertCell(1).textContent = result.single + singleAdjustment;
                row.insertCell(2).textContent = result.group + groupAdjustment;
                
                // 添加说明列
                const noteCell = row.insertCell(3);
                noteCell.className = 'note-cell';
                const noteInput = document.createElement('input');
                noteInput.type = 'text';
                noteInput.className = 'note-input';
                noteInput.value = localStorage.getItem(`note_${result.number}`) || '';
                
                // 保存说明内容
                noteInput.addEventListener('change', () => {
                    localStorage.setItem(`note_${result.number}`, noteInput.value);
                });
                
                noteCell.appendChild(noteInput);
            });
        }

        // 修改清空功能
        function clearInput() {
            inputText.value = '';
            highlightedText.innerHTML = '';
            resultTable.innerHTML = '';
            // 清空所有存储的说明
            clearAllNotes();
        }

        // 添加清空说明的函数
        function clearAllNotes() {
            const keys = Object.keys(localStorage);
            keys.forEach(key => {
                if (key.startsWith('note_')) {
                    localStorage.removeItem(key);
                }
            });
        }

        // 添加页面加载时的处理
        window.addEventListener('load', () => {
            if (!inputText.value.trim()) {
                clearAllNotes();
            }
            // 如果输入框有内容，则触发一次统计更新
            if (inputText.value.trim()) {
                const processed = processText(inputText.value);
                highlightedText.innerHTML = processed.replace(/\n/g, '<br>');
                updateStatistics();
            }
        });

        // 输入事件监听
        inputText.addEventListener('input', () => {
            const processed = processText(inputText.value);
            highlightedText.innerHTML = processed.replace(/\n/g, '<br>');
            // 只有当输入框为空时才清除说明
            if (!inputText.value.trim()) {
                clearAllNotes();
            }
            updateStatistics();
        });

        // 修改复制结果功能
        function copyResults() {
            const rows = resultTable.getElementsByTagName('tr');
            let resultText = '';
            
            Array.from(rows).forEach(row => {
                const cells = row.getElementsByTagName('td');
                if (cells.length === 0) return; // 跳过表头
                
                const number = cells[0].textContent;
                const single = parseInt(cells[1].textContent);
                const group = parseInt(cells[2].textContent);
                const note = cells[3].querySelector('input').value;
                
                let line = number;
                if (single !== 0) {
                    line += ` ${single}单`;
                }
                if (group !== 0) {
                    line += ` ${group}组`;
                }
                if (note) {
                    line += ` (${note})`;
                }
                resultText += line + '\n';
            });
            
            const textarea = document.createElement('textarea');
            textarea.value = resultText;
            document.body.appendChild(textarea);
            textarea.select();
            
            try {
                document.execCommand('copy');
                alert('结果已复制到剪贴板');
            } catch (err) {
                alert('复制失败，请手动复制');
            }
            
            document.body.removeChild(textarea);
        }

        // 自动调整文本框高度
        inputText.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });

        // 添加变化值输入框的事件监听
        document.getElementById('singleAdjustment').addEventListener('input', updateStatistics);
        document.getElementById('groupAdjustment').addEventListener('input', updateStatistics);
    </script>
</body>
</html> 
